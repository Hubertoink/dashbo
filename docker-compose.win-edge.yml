# Windows PC: dashbo-edge (local music + HEOS)
#
# Prereqs:
# - Docker Desktop installed and running
# - Your music is in your Windows library folder (e.g. C:\Users\huber\Musik)
#
# Usage:
# 1) Create a token (PowerShell):
#    $env:EDGE_TOKEN = ( -join ((48..57)+(97..102) | Get-Random -Count 64 | ForEach-Object {[char]$_}) )
#    (or choose your own strong token)
# 2) Run:
#    docker compose -f docker-compose.win-edge.yml up -d --build
#
# Note:
# - DashbO UI is served from https://dashbohub.de. Browsers will block HTTP calls to your Edge (Mixed Content).
#   For real use, put an HTTPS reverse proxy (Caddy/Nginx) in front of the edge.

services:
  dashbo-edge:
    build:
      context: ./edge
    container_name: dashbo-edge
    restart: unless-stopped
    environment:
      PORT: 8787
      # Use a strong token; default "1000" is for quick local testing only.
      EDGE_TOKEN: ${EDGE_TOKEN:-1000}
      # Comma-separated allowed origins for CORS. Include dashbohub.de + local dev URLs.
      EDGE_ALLOWED_ORIGINS: ${EDGE_ALLOWED_ORIGINS:-https://dashbohub.de,http://localhost:8080,http://127.0.0.1:8080,http://localhost:5173}
      # Public/LAN-reachable base URL used for HEOS stream URLs.
      # This allows keeping the UI Edge Base URL on http://localhost:8787 (mixed-content-safe),
      # while speakers stream from a reachable address (e.g. http://192.168.178.27:8787).
      EDGE_PUBLIC_BASE_URL: ${EDGE_PUBLIC_BASE_URL:-}
      MUSIC_LIBRARY_PATH: /mnt/music
      # HEOS discovery/config:
      # - Prefer explicit IPs on Windows Docker (SSDP multicast is often blocked).
      # - Option A: set HEOS_HOST (single IP) or HEOS_HOSTS (comma-separated IPs)
      # - Option B: set HEOS_SCAN_CIDR to enable TCP scan fallback (port 1255), e.g. 192.168.178.0/24
      HEOS_HOST: ${HEOS_HOST:-}
      HEOS_HOSTS: ${HEOS_HOSTS:-}
      HEOS_SCAN_CIDR: ${HEOS_SCAN_CIDR:-}
      HEOS_DISCOVERY_TIMEOUT_MS: ${HEOS_DISCOVERY_TIMEOUT_MS:-5000}
      HEOS_COMMAND_TIMEOUT_MS: ${HEOS_COMMAND_TIMEOUT_MS:-5000}
      HEOS_SCAN_TIMEOUT_MS: ${HEOS_SCAN_TIMEOUT_MS:-200}
      HEOS_SCAN_CONCURRENCY: ${HEOS_SCAN_CONCURRENCY:-64}
    ports:
      - "${EDGE_PORT:-8787}:8787"
    volumes:
      # Adjust to your Windows Music folder path.
      # German Windows is usually: C:/Users/<you>/Musik
      # English Windows is usually: C:/Users/<you>/Music
      - ${MUSIC_DIR:-C:/Users/huber/Music}:/mnt/music:ro
      - dashbo_edge_data:/var/lib/dashbo-edge

volumes:
  dashbo_edge_data:
